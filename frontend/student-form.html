<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Thêm / Sửa sinh viên</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container py-4">
  <a href="index.html" class="btn btn-link">&larr; Quay lại</a>
  <h1 class="h3">Thêm / Sửa sinh viên</h1>

  <div id="alerts"></div>

  <form id="student-form">
    <div class="mb-3">
      <label class="form-label">Tên</label>
      <input type="text" name="name" id="name" class="form-control" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Email</label>
      <input type="email" name="email" id="email" class="form-control">
    </div>
    <div class="mb-3">
      <label class="form-label">Lớp (chọn)</label>
      <select id="class_id" name="class_id" class="form-select">
        <option value="">-- Không chọn --</option>
      </select>
    </div>

    <button class="btn btn-primary" type="submit">Lưu</button>
  </form>
</div>

<script>
const apiStudents = '/web-don-gian/backend/api/students.php';
const apiClasses = '/web-don-gian/backend/api/classes.php';

function showAlert(message, type = 'success'){
  document.getElementById('alerts').innerHTML = `\n    <div class="alert alert-${type} alert-dismissible" role="alert">${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`;
}

function qs(name){
  return new URLSearchParams(window.location.search).get(name);
}

async function loadClasses(){
  const res = await fetch(apiClasses);
  const data = await res.json();
  const sel = document.getElementById('class_id');
  data.forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.name;
    sel.appendChild(opt);
  });
}

async function loadStudent(id){
  const res = await fetch(apiStudents + '?id=' + id);
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Không tìm thấy');
  document.getElementById('name').value = data.name;
  document.getElementById('email').value = data.email || '';
  document.getElementById('class_id').value = data.class_id || '';
}

document.getElementById('student-form').addEventListener('submit', async function(e){
  e.preventDefault();
  const id = qs('id');
  const payload = {
    name: document.getElementById('name').value.trim(),
    email: document.getElementById('email').value.trim() || null,
    class_id: document.getElementById('class_id').value || null
  };
  try {
    const method = id ? 'PUT' : 'POST';
    const url = id ? apiStudents + '?id=' + id : apiStudents;
    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || JSON.stringify(data));
    showAlert('Lưu thành công', 'success');
    setTimeout(()=> window.location.href = 'index.html', 800);
  } catch (err) {
    showAlert('Lỗi: ' + err.message, 'danger');
  }
});

(async ()=>{
  try {
    await loadClasses();
    const id = qs('id');
    if (id) await loadStudent(id);
  } catch (err) {
    showAlert('Không tải dữ liệu: '+ err.message, 'danger');
  }
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>